<!--
=============================================================================
FRONTEND - HoneyPot Pro Max
=============================================================================
Interface utilisateur pour le gestionnaire de mots de passe sécurisé
- Authentification MFA avec TOTP
- Gestion sécurisée des mots de passe
- Interface moderne et responsive
- Intégration avec l'API backend FastAPI

Fonctionnalités principales :
- Connexion utilisateur avec double authentification
- Création et gestion de comptes utilisateurs
- Stockage et récupération de mots de passe chiffrés
- Interface moderne avec design system cohérent

Auteur: Équipe ESGI 2024-2025
=============================================================================
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- =================================================================== -->
    <!-- MÉTADONNÉES ET CONFIGURATION -->
    <!-- =================================================================== -->
    <meta charset="UTF-8">                                           <!-- Encodage UTF-8 pour les caractères français -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  <!-- Responsive design pour mobile -->
    <title>HoneyPot Pro Max - Gestionnaire de mots de passe</title>      <!-- Titre de l'application -->
    
    <style>
        /* =================================================================== */
        /* IMPORTS ET POLICES */
        /* =================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        /* Police moderne Inter pour une meilleure lisibilité */
        
        /* =================================================================== */
        /* VARIABLES CSS - DESIGN SYSTEM */
        /* =================================================================== */
        /* Palette de couleurs cohérente pour toute l'application */
        :root {
            --primary-color: #667eea;          /* Bleu principal pour les éléments interactifs */
            --primary-dark: #5a67d8;           /* Variation foncée pour les états hover */
            --secondary-color: #764ba2;        /* Violet secondaire pour les accents */
            --accent-color: #f093fb;           /* Rose pour les highlights */
            --success-color: #48bb78;          /* Vert pour les messages de succès */
            --error-color: #f56565;            /* Rouge pour les erreurs */
            --warning-color: #ed8936;          /* Orange pour les avertissements */
            --dark-color: #2d3748;             /* Gris foncé pour le texte principal */
            --light-color: #f7fafc;            /* Gris très clair pour les fonds */
            --border-color: #e2e8f0;           /* Gris clair pour les bordures */
            --text-primary: #2d3748;           /* Couleur du texte principal */
            --text-secondary: #718096;         /* Couleur du texte secondaire */
            
            /* Système d'ombres cohérent */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1), 0 10px 10px rgba(0, 0, 0, 0.04);
        }

        /* =================================================================== */
        /* RESET CSS ET STYLES DE BASE */
        /* =================================================================== */
        * {
            margin: 0;                          /* Supprime les marges par défaut */
            padding: 0;                         /* Supprime les paddings par défaut */
            box-sizing: border-box;             /* Inclut padding et border dans la taille */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);     /* Dégradé de fond */
            min-height: 100vh;                  /* Hauteur minimale plein écran */
            color: var(--text-primary);         /* Couleur du texte */
            line-height: 1.6;                   /* Interlignage pour la lisibilité */
            position: relative;                 /* Position pour les pseudo-éléments */
        }

        /* =================================================================== */
        /* EFFETS VISUELS DE FOND */
        /* =================================================================== */
        /* Effet de particules/bulles en arrière-plan pour l'esthétique */
        body::before {
            content: '';
            position: fixed;                    /* Position fixe pour rester en place lors du scroll */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Dégradés radiaux pour créer un effet de profondeur */
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            pointer-events: none;               /* N'interfère pas avec les interactions */
            z-index: -1;                        /* Reste en arrière-plan */
        }

        /* =================================================================== */
        /* BARRE SUPÉRIEURE MODERNE */
        /* =================================================================== */
        /* Header principal avec effet de transparence et blur */
        .topbar {
            background: rgba(255, 255, 255, 0.95);     /* Fond semi-transparent */
            backdrop-filter: blur(20px);               /* Effet de flou moderne */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 20px 30px;
            font-size: 1.8em;
            font-weight: 700;
            letter-spacing: -0.025em;           /* Espacement des lettres ajusté */
            box-shadow: var(--shadow-md);
            position: sticky;                   /* Reste visible lors du scroll */
            top: 0;
            z-index: 100;                       /* Au-dessus des autres éléments */
            display: flex;                      /* Layout flexbox */
            justify-content: space-between;     /* Espacement entre les éléments */
            align-items: center;                /* Centrage vertical */
        }

        /* Titre avec effet de dégradé */
        .topbar .title {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            background-clip: text;              /* Applique le dégradé au texte */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        /* Exception pour l'emoji dans le titre */
        .topbar .title .emoji {
            background: none !important;       /* Annule le dégradé pour l'emoji */
            background-clip: unset !important;
            -webkit-background-clip: unset !important;
            -webkit-text-fill-color: unset !important;
            color: #f39c12 !important;         /* Couleur dorée pour l'emoji */
            filter: none !important;
            display: inline-block !important;
        }

        .logout-btn {
            background: linear-gradient(135deg, var(--error-color), #e53e3e);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            min-width: 160px;
            max-width: 220px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .logout-btn:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* --- Cartes modernes avec glassmorphism --- */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin: 30px auto;
            padding: 40px;
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            max-width: 500px;
            min-width: 320px;
            transition: all 0.3s ease;
            display: none;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--secondary-color));
            border-radius: 24px 24px 0 0;
        }

        #auth-choice.card {
            display: block;
            max-width: 400px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .card h1 {
            margin-bottom: 30px;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 2.2em;
            text-align: center;
            letter-spacing: -0.025em;
        }

        .card h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.5em;
        }

        /* --- Logo avec animation --- */
        .logo-img {
            width: 100px;
            height: 100px;
            margin: 0 auto 30px auto;
            border-radius: 50%;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            display: block;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        .logo-img:hover {
            transform: scale(1.05) rotate(5deg);
            box-shadow: var(--shadow-xl);
        }

        /* --- Champs de saisie modernes --- */
        input {
            width: 100%;
            padding: 16px 20px;
            margin: 12px 0 20px 0;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1em;
            font-weight: 400;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-primary);
        }

        input:focus {
            border: 2px solid var(--primary-color);
            outline: none;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        input::placeholder {
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* --- Boutons modernes avec gradients --- */
        button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.5s ease;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        button:active {
            transform: translateY(0);
        }

        /* --- Boutons spécialisés --- */
        .btn-danger {
            background: linear-gradient(135deg, var(--error-color), #e53e3e);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #38a169);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--text-secondary), #4a5568);
        }

        /* --- Gestionnaire principal avec layout amélioré --- */
        #app.card {
            max-width: 900px;
            padding: 50px;
        }

        #app h1 {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
        }

        /* --- Formulaire en grid moderne --- */
        .form-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* --- Actions en grille responsive --- */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .actions-grid button {
            margin: 0;
            padding: 14px 20px;
            font-size: 0.95em;
        }

        /* --- Container pour champs mot de passe amélioré --- */
        .password-container {
            position: relative;
            display: block;
            width: 100%;
        }
        
        .password-container input {
            padding-right: 50px;
            width: 100%;
        }
        
        .password-container input::-ms-reveal {
            display: none;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            cursor: pointer;
            padding: 8px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            width: 40px;
        }
        
        .password-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-50%) scale(1.05);
        }
        
        .password-toggle svg {
            display: block;
            width: 20px;
            height: 20px;
            fill: var(--text-secondary);
            transition: fill 0.3s ease;
            opacity: 1;
        }
        
        .password-toggle:hover svg {
            fill: var(--primary-color);
        }

        /* --- Tableau moderne avec style élégant --- */
        #password-list {
            margin-top: 40px;
        }

        #password-list table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        #password-list th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #password-list td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            text-align: center;
        }

        #password-list tr:last-child td {
            border-bottom: none;
        }

        #password-list tr:nth-child(even) {
            background: rgba(102, 126, 234, 0.02);
        }

        #password-list tr:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        /* --- Boutons d'action du tableau --- */
        .table-action-btn {
            padding: 8px 16px;
            margin: 0 4px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 500;
            min-width: 80px;
            transition: all 0.3s ease;
        }

        /* --- Suggestions améliorées --- */
        #site-link-list {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 10;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }

        #site-link-list div {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        #site-link-list div:last-child {
            border-bottom: none;
        }

        #site-link-list div:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            transform: translateX(5px);
        }

        /* --- Indicateurs de complexité du mot de passe --- */
        #password-hint {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            border-left: 4px solid var(--warning-color);
            box-shadow: var(--shadow-sm);
        }

        #password-hint ul {
            list-style: none;
            margin: 8px 0 0 0;
        }

        #password-hint li {
            padding: 4px 0;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }

        #password-hint li::before {
            content: '•';
            margin-right: 8px;
            font-size: 1.2em;
        }

        /* --- Messages d'erreur stylisés --- */
        #add-error {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid rgba(245, 101, 101, 0.3);
            color: var(--error-color);
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 0.9em;
            font-weight: 500;
        }

        /* --- Liens stylisés --- */
        a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        /* --- Responsive design amélioré --- */
        @media (max-width: 768px) {
            .card {
                margin: 20px;
                padding: 30px 25px;
                max-width: none;
            }

            #app.card {
                padding: 30px 25px;
            }

            .topbar {
                font-size: 1.4em;
                padding: 15px 20px;
            }

            .logout-btn {
                padding: 8px 16px;
                font-size: 0.8em;
                min-width: 120px;
                max-width: 150px;
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }

            #password-list table {
                font-size: 0.85em;
            }

            .table-action-btn {
                padding: 6px 12px;
                font-size: 0.8em;
                min-width: 70px;
            }
        }

        @media (max-width: 480px) {
            .card h1 {
                font-size: 1.8em;
            }

            input, button {
                padding: 14px 16px;
            }

            #password-list th, #password-list td {
                padding: 12px 8px;
            }

            .topbar {
                font-size: 1.2em;
                padding: 12px 15px;
            }

            .topbar .title {
                font-size: 1em;
            }

            .logout-btn {
                padding: 6px 12px;
                font-size: 0.75em;
                min-width: 100px;
                max-width: 130px;
            }
        }

        /* --- Animations et transitions globales --- */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: fadeInUp 0.6s ease-out;
        }

        /* --- États de chargement --- */
        .loading {
            position: relative;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-color);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Barre supérieure moderne -->
    <div class="topbar">
        <div style="display: flex; align-items: center;">
            <span style="color: #f39c12; margin-right: 8px; font-size: 1em;">🔐</span>
            <span class="title">HoneyPot Pro Max</span>
        </div>
        <button id="logout-btn" class="logout-btn" style="display:none;" onclick="logout()">
            <span>🚪 Déconnexion</span>
        </button>
    </div>

    <!-- Page d'accueil moderne -->
    <div id="auth-choice" class="card" style="display:block;">
        <h1>✨ Bienvenue sur HoneyPot Pro Max</h1>
        <img src="images/HoneyPot.png" alt="Logo HoneyPot Pro Max" class="logo-img">
        <p style="text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 1.1em;">
            Votre gestionnaire de mots de passe sécurisé et moderne
        </p>
        <button onclick="showSignup()" class="btn-success">
            <span>🆕 Créer un compte</span>
        </button>
        <button onclick="showLogin()">
            <span>🔑 Se connecter</span>
        </button>
    </div>

    <!-- Formulaire de création de compte moderne -->
    <div id="setup-container" class="card" style="display: none;">
        <h1>📝 Créer votre compte</h1>
        
        <div class="form-group">
            <label class="form-label">👤 Identifiant</label>
            <input type="text" id="new-username" placeholder="Choisissez votre identifiant unique">
        </div>
        
        <div class="form-group">
            <label class="form-label">🔐 Mot de passe maître</label>
            <div class="password-container">
                <input type="password" id="new-master-password" placeholder="Créez un mot de passe sécurisé" oninput="updatePasswordHint()">
                <span class="password-toggle" onclick="toggleNewPassword()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M12.015 7c4.751 0 8.063 3.012 9.504 4.636-1.401 1.837-4.713 5.364-9.504 5.364-4.42 0-7.93-3.536-9.478-5.407 1.493-1.647 4.817-4.593 9.478-4.593zm0-2c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 3c-2.209 0-4 1.792-4 4 0 2.209 1.791 4 4s4-1.791 4-4c0-2.208-1.791-4-4-4z"/>
                    </svg>
                </span>
            </div>
        </div>
        
        <div id="password-hint" style="display:none;"></div>
        
        <button onclick="setMasterPassword()" class="btn-success">
            <span>✅ Créer mon compte</span>
        </button>
        
        <div style="margin-top:20px;text-align:center;">
            <a href="#" onclick="showLogin();return false;">
                <span>🔄 Déjà un compte ? Se connecter</span>
            </a>
        </div>
    </div>

    <!-- Formulaire de connexion moderne -->
    <div id="auth-container" class="card">
        <h1>🔐 Connexion</h1>
        
        <div class="form-group">
            <label class="form-label">👤 Identifiant</label>
            <input type="text" id="login-username" placeholder="Saisissez votre identifiant">
        </div>
        
        <div class="form-group">
            <label class="form-label">🔑 Mot de passe</label>
            <div class="password-container">
                <input type="password" id="master-password" placeholder="Saisissez votre mot de passe">
                <span class="password-toggle" onclick="toggleLoginPassword()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M12.015 7c4.751 0 8.063 3.012 9.504 4.636-1.401 1.837-4.713 5.364-9.504 5.364-4.42 0-7.93-3.536-9.478-5.407 1.493-1.647 4.817-4.593 9.478-4.593zm0-2c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 3c-2.209 0-4 1.792-4 4 0 2.209 1.791 4 4s4-1.791 4-4c0-2.208-1.791-4-4-4z"/>
                    </svg>
                </span>
            </div>
        </div>
        
        <button onclick="authenticate()">
            <span>🚪 Se connecter</span>
        </button>
        
        <div style="margin-top:20px;text-align:center;">
            <a href="#" onclick="showSignup();return false;">
                <span>🆕 Créer un compte</span>
            </a>
        </div>
    </div>    <!-- Gestionnaire de mots de passe moderne -->
    <div id="app" class="card">
        <h1>🔐 Vos mots de passe sécurisés</h1>
        
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">👤 Identifiant du compte</label>
                <input type="text" id="account-username" placeholder="Ex: john.doe@gmail.com">
            </div>
            
            <div class="form-group" style="position:relative;">
                <label class="form-label">🌐 Site web</label>
                <input type="text" id="site-link" placeholder="Ex: https://www.google.com" autocomplete="off" oninput="showSiteSuggestions()" onblur="hideSiteSuggestionsWithDelay()">
                <div id="site-link-list"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">🔑 Mot de passe</label>
                <div class="password-container">
                    <input type="password" id="password" placeholder="Votre mot de passe sécurisé">
                    <span class="password-toggle" onclick="toggleMainPassword()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path d="M12.015 7c4.751 0 8.063 3.012 9.504 4.636-1.401 1.837-4.713 5.364-9.504 5.364-4.42 0-7.93-3.536-9.478-5.407 1.493-1.647 4.817-4.593 9.478-4.593zm0-2c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 3c-2.209 0-4 1.792-4 4 0 2.209 1.791 4 4s4-1.791 4-4c0-2.208-1.791-4-4-4z"/>
                        </svg>
                    </span>
                </div>
            </div>
        </div>
        
        <div class="actions-grid">
            <button onclick="generatePassword()">
                <span>🎲 Générer un mot de passe</span>
            </button>
            <button onclick="addPassword()" class="btn-success">
                <span>➕ Ajouter</span>
            </button>
            <button onclick="showMfaSettings()" class="btn-secondary">
                <span>🔐 Gérer la 2FA</span>
            </button>
            <button onclick="deleteAllPasswords()" class="btn-danger">
                <span>🗑️ Supprimer tout</span>
            </button>
        </div>
        
        <div id="add-error" style="display:none;"></div>
        
        <!-- Section des mots de passe sauvegardés -->
        <div id="password-list"></div>
    </div>

    <!-- Interface de gestion MFA/2FA -->
    <div id="mfa-settings" class="card">
        <h1>🔐 Authentification à deux facteurs (2FA)</h1>
        
        <div id="mfa-status" style="margin-bottom: 30px;">
            <div style="padding: 20px; border-radius: 12px; background: rgba(255, 193, 7, 0.1); border-left: 4px solid var(--warning-color);">
                <p><strong>🔄 Vérification du statut MFA...</strong></p>
            </div>
        </div>

        <!-- Activation de la MFA -->
        <div id="mfa-setup" style="display: none;">
            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                <h3>📱 Configurer l'authentification à deux facteurs</h3>
                <p style="margin-bottom: 20px;">1. Téléchargez une application d'authentification comme <strong>Google Authenticator</strong>, <strong>Authy</strong> ou <strong>Microsoft Authenticator</strong></p>
                <p style="margin-bottom: 20px;">2. Scannez le QR code ci-dessous avec votre application :</p>
                
                <div id="qr-code" style="text-align: center; margin: 20px 0; padding: 20px; background: white; border-radius: 12px; display: inline-block; width: 100%;"></div>
                
                <p style="margin-bottom: 20px;">3. Entrez le code à 6 chiffres généré par votre application pour confirmer :</p>
                
                <div class="form-group">
                    <input type="text" id="mfa-verify-code" placeholder="123456" maxlength="6" style="text-align: center; font-size: 1.2em; letter-spacing: 0.3em;">
                </div>
                
                <button onclick="setupMfa()" class="btn-success">
                    <span>✅ Activer la 2FA</span>
                </button>
            </div>
        </div>

        <!-- MFA déjà activée -->
        <div id="mfa-active" style="display: none;">
            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                <h3>✅ Authentification à deux facteurs activée</h3>
                <p>Votre compte est protégé par l'authentification à deux facteurs. Un code de vérification sera requis à chaque connexion.</p>
            </div>
            
            <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 12px; padding: 20px;">
                <h4>⚠️ Désactivation de la 2FA</h4>
                <p>La désactivation de la 2FA n'est pas encore disponible via l'interface. Contactez l'administrateur si nécessaire.</p>
                <p><em>Cette fonctionnalité sera disponible dans une prochaine mise à jour.</em></p>
            </div>
        </div>

        <button onclick="backToMainApp()" class="btn-secondary" style="margin-top: 30px;">
            <span>🔙 Retour au gestionnaire</span>
        </button>
    </div>

    <!-- Interface de vérification MFA lors de la connexion -->
    <div id="mfa-verification" class="card">
        <h1>🔐 Vérification en deux étapes</h1>
        
        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 30px; text-align: center;">
            <p><strong>📱 Ouvrez votre application d'authentification</strong></p>
            <p>Entrez le code à 6 chiffres affiché pour <strong id="mfa-username-display"></strong></p>
        </div>
        
        <div class="form-group">
            <label class="form-label">🔢 Code de vérification</label>
            <input type="text" id="mfa-login-code" placeholder="123456" maxlength="6" style="text-align: center; font-size: 1.5em; letter-spacing: 0.3em;">
        </div>
        
        <button onclick="verifyMfaLogin()" class="btn-success">
            <span>✅ Vérifier et se connecter</span>
        </button>
        
        <div style="margin-top: 20px; text-align: center;">
            <a href="#" onclick="cancelMfaLogin(); return false;">
                <span>🔙 Annuler la connexion</span>
            </a>
        </div>
    </div>

    <script>
        // Variables globales pour MFA
        let mfaSetupData = null;
        let pendingUsername = null;
        let pendingPassword = null;

        // Affiche uniquement le conteneur demandé, cache les autres
        function showOnly(id) {
            ["auth-choice", "setup-container", "auth-container", "app", "mfa-settings", "mfa-verification"].forEach(function(div) {
                document.getElementById(div).style.display = (div === id) ? "block" : "none";
            });
            document.getElementById("logout-btn").style.display = (["app", "mfa-settings"].includes(id)) ? "block" : "none";
        }

        // Affiche le formulaire de création de compte
        function showSignup() {
            // Sécurité : vider tous les champs de mot de passe
            clearAllPasswordFields();
            showOnly("setup-container");
        }

        // Affiche le formulaire de connexion
        function showLogin() {
            // Sécurité : vider tous les champs de mot de passe
            clearAllPasswordFields();
            if (localStorage.getItem("masterPassword") && localStorage.getItem("username")) {
                showOnly("auth-container");
            } else {
                alert("Aucun compte trouvé, veuillez créer un compte.");
            }
        }

        // Fonction de sécurité pour vider tous les champs sensibles
        function clearAllPasswordFields() {
            const passwordFields = [
                "new-master-password",
                "master-password", 
                "password",
                "mfa-verify-code",
                "mfa-login-code"
            ];
            
            passwordFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = "";
                    // Réinitialiser le type en mode masqué
                    if (field.type === "text" && field.parentElement.classList.contains('password-container')) {
                        field.type = "password";
                        const toggleIcon = field.parentElement.querySelector('.password-toggle svg');
                        if (toggleIcon) {
                            toggleIcon.innerHTML = '<path d="M12.015 7c4.751 0 8.063 3.012 9.504 4.636-1.401 1.837-4.713 5.364-9.504 5.364-4.42 0-7.93-3.536-9.478-5.407 1.493-1.647 4.817-4.593 9.478-4.593zm0-2c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 3c-2.209 0-4 1.792-4 4 0 2.209 1.791 4 4s4-1.791 4-4c0-2.208-1.791-4-4-4z"/>';
                        }
                    }
                }
            });
            
            // Masquer les hints de mot de passe
            const hintDiv = document.getElementById("password-hint");
            if (hintDiv) {
                hintDiv.style.display = "none";
            }
        }

        // Vérifie la complexité du mot de passe
        function checkPasswordComplexity(password) {
            const minLength = 8;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasDigit = /\d/.test(password);
            const hasSpecial = /[!@#$%^&*()_\-+=\[\]{};':"\\|,.<>\/?]/.test(password);
            return {
                minLength: password.length >= minLength,
                hasUpper,
                hasLower,
                hasDigit,
                hasSpecial
            };
        }

        // Affiche les conseils de complexité du mot de passe
        function updatePasswordHint() {
            const password = document.getElementById("new-master-password").value;
            const hintDiv = document.getElementById("password-hint");
            const checks = checkPasswordComplexity(password);

            let html = "Le mot de passe n'est pas assez complexe.<br>Il doit contenir au moins :<ul style='margin:4px 0 0 18px;padding:0;'>";
            html += `<li style="color:${checks.minLength ? '#22c55e' : '#ef4444'}">8 caractères</li>`;
            html += `<li style="color:${checks.hasUpper ? '#22c55e' : '#ef4444'}">une lettre majuscule</li>`;
            html += `<li style="color:${checks.hasLower ? '#22c55e' : '#ef4444'}">une lettre minuscule</li>`;
            html += `<li style="color:${checks.hasDigit ? '#22c55e' : '#ef4444'}">un chiffre</li>`;
            html += `<li style="color:${checks.hasSpecial ? '#22c55e' : '#ef4444'}">un caractère spécial (ex: !@#$%^&amp;*)</li>`;
            html += "</ul>";

            // Affiche le hint si le champ n'est pas vide ou si tout n'est pas validé
            if (password.length > 0 && Object.values(checks).some(v => !v)) {
                hintDiv.innerHTML = html;
                hintDiv.style.display = "block";
            } else {
                hintDiv.style.display = "none";
            }
        }

        // Création de compte
        function setMasterPassword() {
            const newUsername = document.getElementById("new-username").value;
            const newPassword = document.getElementById("new-master-password").value;
            const hintDiv = document.getElementById("password-hint");
            hintDiv.style.display = "none";
            hintDiv.textContent = "";

            if (!newUsername || !newPassword) {
                hintDiv.textContent = "Veuillez saisir un identifiant et un mot de passe.";
                hintDiv.style.display = "block";
                return;
            }

            const checks = checkPasswordComplexity(newPassword);
            if (!checks.minLength || !checks.hasUpper || !checks.hasLower || !checks.hasDigit || !checks.hasSpecial) {
                updatePasswordHint();
                return;
            }

            const hashedKey = btoa(newUsername + ":" + newPassword);
            localStorage.setItem("masterPassword", btoa(newPassword));
            localStorage.setItem("username", newUsername);
            localStorage.setItem("currentUser", hashedKey);

            fetch("/api/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username: newUsername, password: newPassword })
            })
            .then(res => res.json())
            .then(data => {
                if (data.message === "Utilisateur créé avec succès") {
                    alert("Compte créé !");
                    showOnly("auth-container");
                } else {
                    alert("Erreur : " + (data.detail || JSON.stringify(data)));
                }
            })
            .catch(err => alert("Erreur API : " + err.message));
        }

        // Connexion utilisateur
        function authenticate() {
            const enteredUsername = document.getElementById("login-username").value;
            const enteredPassword = document.getElementById("master-password").value;
            const savedUsername = localStorage.getItem("username");
            const savedPassword = localStorage.getItem("masterPassword");

            if (!enteredUsername || !enteredPassword) {
                alert("Veuillez saisir l'identifiant et le mot de passe");
                return;
            }

            if (enteredUsername === savedUsername && btoa(enteredPassword) === savedPassword) {
                // Utiliser l'endpoint /api/login du backend pour vérifier si MFA est requis
                fetch("/api/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username: enteredUsername, password: enteredPassword })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.mfa_required) {
                        // MFA activée, demander le code de vérification
                        pendingUsername = enteredUsername;
                        pendingPassword = enteredPassword;
                        document.getElementById("mfa-username-display").textContent = enteredUsername;
                        showOnly("mfa-verification");
                    } else {
                        // Pas de MFA, connexion directe
                        localStorage.setItem("currentUser", data.user_b64_token || btoa(enteredUsername + ":" + enteredPassword));
                        showOnly("app");
                        displayPasswords();
                    }
                })
                .catch(err => {
                    console.error("Erreur vérification login:", err);
                    // En cas d'erreur, connexion normale (fallback)
                    localStorage.setItem("currentUser", btoa(enteredUsername + ":" + enteredPassword));
                    showOnly("app");
                    displayPasswords();
                });
            } else {
                alert("Identifiant ou mot de passe incorrect");
            }
        }

        // Génère un mot de passe aléatoire
        function generatePassword() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()";
            const password = Array.from({ length: 12 }, () => chars[Math.floor(Math.random() * chars.length)]).join("");
            const passwordInput = document.getElementById("password");
            passwordInput.value = password;
        }

        // Fonctions pour afficher/masquer les mots de passe avec les icônes SVG
        function toggleMainPassword() {
            const passwordInput = document.getElementById("password");
            const toggleIcon = passwordInput.parentElement.querySelector('.password-toggle svg');
            
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                // Icône œil barré (mot de passe visible)
                toggleIcon.innerHTML = '<path d="M11.83,9L15,12.16C15,12.11 15,12.05 15,12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,11.21 7.2,10.47 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.08L19.73,22L21,20.73L3.27,3M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.57,16.75C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.26,4.75 8,5.2L10.17,7.35C10.76,7.13 11.37,7 12,7Z"/>';
            } else {
                passwordInput.type = "password";
                // Icône œil normal (mot de passe masqué)
                toggleIcon.innerHTML = '<path d="M12.015 7c4.751 0 8.063 3.012 9.504 4.636-1.401 1.837-4.713 5.364-9.504 5.364-4.42 0-7.93-3.536-9.478-5.407 1.493-1.647 4.817-4.593 9.478-4.593zm0-2c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 3c-2.209 0-4 1.792-4 4 0 2.209 1.791 4 4s4-1.791 4-4c0-2.208-1.791-4-4-4z"/>';
            }
        }

        function toggleNewPassword() {
            const passwordInput = document.getElementById("new-master-password");
            const toggleIcon = passwordInput.parentElement.querySelector('.password-toggle svg');
            
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                // Icône œil barré (mot de passe visible)
                toggleIcon.innerHTML = '<path d="M11.83,9L15,12.16C15,12.11 15,12.05 15,12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,11.21 7.2,10.47 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.08L19.73,22L21,20.73L3.27,3M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.57,16.75C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.26,4.75 8,5.2L10.17,7.35C10.76,7.13 11.37,7 12,7Z"/>';
            } else {
                passwordInput.type = "password";
                // Icône œil normal (mot de passe masqué)
                toggleIcon.innerHTML = '<path d="M12.015 7c4.751 0 8.063 3.012 9.504 4.636-1.401 1.837-4.713 5.364-9.504 5.364-4.42 0-7.93-3.536-9.478-5.407 1.493-1.647 4.817-4.593 9.478-4.593zm0-2c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 3c-2.209 0-4 1.792-4 4 0 2.209 1.791 4 4s4-1.791 4-4c0-2.208-1.791-4-4-4z"/>';
            }
        }

        function toggleLoginPassword() {
            const passwordInput = document.getElementById("master-password");
            const toggleIcon = passwordInput.parentElement.querySelector('.password-toggle svg');
            
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                // Icône œil barré (mot de passe visible)
                toggleIcon.innerHTML = '<path d="M11.83,9L15,12.16C15,12.11 15,12.05 15,12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,11.21 7.2,10.47 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.08L19.73,22L21,20.73L3.27,3M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.57,16.75C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.26,4.75 8,5.2L10.17,7.35C10.76,7.13 11.37,7 12,7Z"/>';
            } else {
                passwordInput.type = "password";
                // Icône œil normal (mot de passe masqué)
                toggleIcon.innerHTML = '<path d="M12.015 7c4.751 0 8.063 3.012 9.504 4.636-1.401 1.837-4.713 5.364-9.504 5.364-4.42 0-7.93-3.536-9.478-5.407 1.493-1.647 4.817-4.593 9.478-4.593zm0-2c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 3c-2.209 0-4 1.792-4 4 0 2.209 1.791 4 4s4-1.791 4-4c0-2.208-1.791-4-4-4z"/>';
            }
        }

        // Stocke les mots de passe récupérés pour vérifier les doublons côté client
        let currentPasswords = [];

        // Ajoute un mot de passe pour un site/compte
        function addPassword() {
            const accountUsername = document.getElementById("account-username").value.trim();
            const siteLink = document.getElementById("site-link").value.trim();
            const password = document.getElementById("password").value;
            const user = localStorage.getItem("currentUser");
            const errorDiv = document.getElementById("add-error");
            errorDiv.style.display = "none";
            errorDiv.textContent = "";

            if (!accountUsername || !siteLink || !password) {
                errorDiv.textContent = "Veuillez remplir tous les champs";
                errorDiv.style.display = "block";
                return;
            }

            // Vérifie côté client s'il existe déjà ce compte pour ce site
            const duplicate = currentPasswords.find(
                item => item.site === siteLink && item.account === accountUsername
            );
            if (duplicate) {
                errorDiv.textContent = "Un compte avec cet identifiant existe déjà pour ce site.";
                errorDiv.style.display = "block";
                return;
            }

            fetch("/api/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user, site: siteLink, account: accountUsername, password })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                displayPasswords();
            })
            .catch(err => {
                errorDiv.textContent = "Erreur ajout : " + err.message;
                errorDiv.style.display = "block";
            });
        }

        // Affiche la liste des mots de passe dans un tableau
        function displayPasswords() {
            const user = localStorage.getItem("currentUser");
            fetch(`/api/list?user=${user}`)
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById("password-list");
                    list.innerHTML = "";

                    if (!data.passwords || !Array.isArray(data.passwords) || data.passwords.length === 0) {
                        list.innerHTML = "<p>Aucun mot de passe trouvé ou erreur de chargement.</p>";
                        currentPasswords = [];
                        return;
                    }

                    currentPasswords = data.passwords;

                    // Table header
                    let html = `<table>
                        <thead>
                            <tr>
                                <th style="width:30%;">Site</th>
                                <th style="width:30%;">Identifiant</th>
                                <th style="width:25%;">Mot de passe</th>
                                <th style="width:15%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    data.passwords.forEach((item, index) => {
                        html += `
                            <tr>
                                <td>${item.site}</td>
                                <td>${item.account}</td>
                                <td>
                                    <span id="pwd-${index}">*****</span>
                                </td>
                                <td>
                                    <button class="table-action-btn" onclick="togglePassword(${index}, '${item.password}')">Voir</button>
                                    <button class="table-action-btn" style="background:#ef4444;color:#fff;" onclick="deletePassword('${item.site}','${item.account}')">Supprimer</button>
                                </td>
                            </tr>
                        `;
                    });

                    html += "</tbody></table>";
                    list.innerHTML = html;
                })
                .catch(err => {
                    console.error("Erreur lors du chargement des mots de passe :", err);
                });
        }

        // Affiche ou masque le mot de passe
        function togglePassword(index, password) {
            const span = document.getElementById(`pwd-${index}`);
            span.textContent = span.textContent === "*****" ? password : "*****";
        }

        // Supprime un mot de passe pour un site/compte
        function deletePassword(site, account) {
            const user = localStorage.getItem("currentUser");

            fetch("/api/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user, site, account })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                displayPasswords();
            })
            .catch(err => alert("Erreur suppression : " + err.message));
        }

        // Supprime tous les mots de passe de l'utilisateur
        function deleteAllPasswords() {
            if (!confirm("Êtes-vous sûr de vouloir supprimer tous vos mots de passe ?")) return;
            const user = localStorage.getItem("currentUser");
            fetch("/api/delete_all", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                displayPasswords();
            })
            .catch(err => alert("Erreur suppression : " + err.message));
        }

        // Déconnexion utilisateur
        function logout() {
            localStorage.removeItem("currentUser");

            // Sécurité : vider tous les champs sensibles
            clearAllPasswordFields();

            // Réinitialiser les champs du gestionnaire
            document.getElementById("account-username").value = "";
            document.getElementById("site-link").value = "";

            // Réinitialiser les variables MFA
            pendingUsername = null;
            pendingPassword = null;
            mfaSetupData = null;

            document.getElementById("app").style.display = "none";
            document.getElementById("mfa-settings").style.display = "none";
            document.getElementById("mfa-verification").style.display = "none";
            document.getElementById("auth-choice").style.display = "block";
            document.getElementById("logout-btn").style.display = "none";
        }

        // Suggestions de sites populaires
        const popularSites = [
            "https://www.google.com",
            "https://www.facebook.com",
            "https://www.youtube.com",
            "https://www.twitter.com",
            "https://www.instagram.com",
            "https://www.linkedin.com",
            "https://www.github.com",
            "https://www.microsoft.com",
            "https://www.amazon.com",
            "https://www.reddit.com",
            "https://www.wikipedia.org",
            "https://www.yahoo.com"
        ];

        function showSiteSuggestions() {
            const input = document.getElementById("site-link");
            const listDiv = document.getElementById("site-link-list");
            const value = input.value.trim().toLowerCase();
            if (!value) {
                listDiv.style.display = "none";
                listDiv.innerHTML = "";
                return;
            }
            // Suggestions à partir des sites populaires + ceux déjà enregistrés
            const allSites = Array.from(new Set([
                ...popularSites,
                ...currentPasswords.map(item => item.site)
            ]));
            const filtered = allSites.filter(site => site.toLowerCase().includes(value));
            if (filtered.length === 0) {
                listDiv.style.display = "none";
                listDiv.innerHTML = "";
                return;
            }
            listDiv.innerHTML = filtered.map(site =>
                `<div onclick="selectSiteSuggestion('${site.replace(/'/g, "\\'")}')">${site}</div>`
            ).join("");
            listDiv.style.display = "block";
        }

        function selectSiteSuggestion(site) {
            document.getElementById("site-link").value = site;
            document.getElementById("site-link-list").style.display = "none";
        }

        function hideSiteSuggestionsWithDelay() {
            setTimeout(() => {
                document.getElementById("site-link-list").style.display = "none";
            }, 150);
        }

        // ========== FONCTIONS MFA/2FA ==========

        // Affiche l'interface de gestion MFA
        function showMfaSettings() {
            showOnly("mfa-settings");
            loadMfaStatus();
        }

        // Retourne au gestionnaire principal
        function backToMainApp() {
            showOnly("app");
        }

        // Charge le statut MFA de l'utilisateur
        function loadMfaStatus() {
            const user = localStorage.getItem("currentUser");
            const statusDiv = document.getElementById("mfa-status");
            const setupDiv = document.getElementById("mfa-setup");
            const activeDiv = document.getElementById("mfa-active");

            // Essayer de faire un setup MFA pour détecter si déjà activé
            fetch("/api/mfa/setup", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user })
            })
            .then(res => res.json())
            .then(data => {
                if (data.detail && data.detail.includes("déjà activé")) {
                    // MFA déjà activée
                    statusDiv.innerHTML = `
                        <div style="padding: 20px; border-radius: 12px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--success-color);">
                            <p><strong>✅ Authentification à deux facteurs activée</strong></p>
                            <p>Votre compte est protégé par la 2FA.</p>
                        </div>
                    `;
                    setupDiv.style.display = "none";
                    activeDiv.style.display = "block";
                } else if (data.provisioning_uri) {
                    // MFA pas encore activée, on peut la configurer
                    statusDiv.innerHTML = `
                        <div style="padding: 20px; border-radius: 12px; background: rgba(245, 101, 101, 0.1); border-left: 4px solid var(--error-color);">
                            <p><strong>⚠️ Authentification à deux facteurs désactivée</strong></p>
                            <p>Votre compte n'est protégé que par votre mot de passe. Activez la 2FA pour plus de sécurité.</p>
                        </div>
                    `;
                    setupDiv.style.display = "block";
                    activeDiv.style.display = "none";
                    generateMfaSetupFromData(data);
                } else {
                    // Erreur inconnue
                    statusDiv.innerHTML = `
                        <div style="padding: 20px; border-radius: 12px; background: rgba(245, 101, 101, 0.1); border-left: 4px solid var(--error-color);">
                            <p><strong>❌ Erreur lors de la vérification du statut MFA</strong></p>
                            <p>Réponse inattendue du serveur : ${JSON.stringify(data)}</p>
                        </div>
                    `;
                }
            })
            .catch(err => {
                console.error("Erreur statut MFA:", err);
                statusDiv.innerHTML = `
                    <div style="padding: 20px; border-radius: 12px; background: rgba(245, 101, 101, 0.1); border-left: 4px solid var(--error-color);">
                        <p><strong>❌ Erreur lors de la vérification du statut MFA</strong></p>
                        <p>Erreur réseau : ${err.message}</p>
                    </div>
                `;
            });
        }

        // Génère la configuration MFA à partir des données reçues
        function generateMfaSetupFromData(data) {
            if (data.provisioning_uri) {
                mfaSetupData = data;
                // Générer l'URL du QR code en utilisant un service en ligne
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(data.provisioning_uri)}`;
                document.getElementById("qr-code").innerHTML = `
                    <img src="${qrCodeUrl}" alt="QR Code MFA" style="max-width: 200px; border: 2px solid #ddd; border-radius: 8px;">
                    <p style="margin-top: 15px; font-size: 0.9em; color: var(--text-secondary);">
                        <strong>Configuration manuelle :</strong><br>
                        Nom de l'app : ProjetAnnuelESGI<br>
                        Utilisateur : ${atob(localStorage.getItem("currentUser")).split(':')[0]}
                    </p>
                `;
            }
        }

        // Génère la configuration MFA (QR code) - version simplifiée
        function generateMfaSetup() {
            // Cette fonction est appelée depuis loadMfaStatus maintenant
            // Ne fait rien car le setup est déjà fait
        }

        // Active la MFA avec le code de vérification
        function setupMfa() {
            const code = document.getElementById("mfa-verify-code").value.trim();
            
            if (!code || code.length !== 6) {
                alert("Veuillez entrer un code à 6 chiffres");
                return;
            }

            const user = localStorage.getItem("currentUser");

            fetch("/api/mfa/verify", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user, otp_code: code })
            })
            .then(res => res.json())
            .then(data => {
                if (data.message && data.message.includes("succès")) {
                    alert("✅ Authentification à deux facteurs activée avec succès !");
                    document.getElementById("mfa-verify-code").value = "";
                    loadMfaStatus(); // Recharger le statut
                } else {
                    alert("❌ Code de vérification incorrect. Veuillez réessayer.");
                }
            })
            .catch(err => {
                console.error("Erreur vérification MFA:", err);
                alert("Erreur lors de l'activation MFA : " + err.message);
            });
        }

        // Vérifie le code MFA lors de la connexion
        function verifyMfaLogin() {
            const code = document.getElementById("mfa-login-code").value.trim();
            
            if (!code || code.length !== 6) {
                alert("Veuillez entrer un code à 6 chiffres");
                return;
            }

            if (!pendingUsername) {
                alert("Erreur de session. Veuillez vous reconnecter.");
                showOnly("auth-container");
                return;
            }

            fetch("/api/login/otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    username: pendingUsername, 
                    otp_code: code 
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.message && data.message.includes("réussie")) {
                    // Code correct, connexion réussie
                    localStorage.setItem("currentUser", btoa(pendingUsername + ":" + pendingPassword));
                    
                    // Réinitialiser les variables temporaires
                    pendingUsername = null;
                    pendingPassword = null;
                    document.getElementById("mfa-login-code").value = "";
                    
                    // Aller au gestionnaire principal
                    showOnly("app");
                    displayPasswords();
                } else {
                    alert("❌ Code de vérification incorrect. Veuillez réessayer.");
                    document.getElementById("mfa-login-code").focus();
                }
            })
            .catch(err => {
                console.error("Erreur vérification MFA login:", err);
                alert("Erreur lors de la vérification : " + err.message);
            });
        }

        // Annule la connexion MFA
        function cancelMfaLogin() {
            pendingUsername = null;
            pendingPassword = null;
            document.getElementById("mfa-login-code").value = "";
            showOnly("auth-container");
        }
    </script>
</body>
</html>
