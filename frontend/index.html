<!--
=============================================================================
FRONTEND - HoneyPot Pro Max
=============================================================================
Interface utilisateur pour le gestionnaire de mots de passe s√©curis√©
- Authentification MFA avec TOTP
- Gestion s√©curis√©e des mots de passe
- Interface moderne et responsive
- Int√©gration avec l'API backend FastAPI

Fonctionnalit√©s principales :
- Connexion utilisateur avec double authentification
- Cr√©ation et gestion de comptes utilisateurs
- Stockage et r√©cup√©ration de mots de passe chiffr√©s
- Interface moderne avec design system coh√©rent

Auteur: √âquipe ESGI 2024-2025
=============================================================================
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- =================================================================== -->
    <!-- M√âTADONN√âES ET CONFIGURATION -->
    <!-- =================================================================== -->
    <meta charset="UTF-8">                                           <!-- Encodage UTF-8 pour les caract√®res fran√ßais -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  <!-- Responsive design pour mobile -->
    <title>HoneyPot Pro Max - Gestionnaire de mots de passe</title>      <!-- Titre de l'application -->
    
    <!-- Biblioth√®que QR Code Generator - Plus fiable que QRCode.js -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    
    <style>
        /* =================================================================== */
        /* IMPORTS ET POLICES */
        /* =================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        /* Police moderne Inter pour une meilleure lisibilit√© */
        
        /* =================================================================== */
        /* VARIABLES CSS - DESIGN SYSTEM */
        /* =================================================================== */
        /* Palette de couleurs coh√©rente pour toute l'application */
        :root {
            --primary-color: #667eea;          /* Bleu principal pour les √©l√©ments interactifs */
            --primary-dark: #5a67d8;           /* Variation fonc√©e pour les √©tats hover */
            --secondary-color: #764ba2;        /* Violet secondaire pour les accents */
            --accent-color: #f093fb;           /* Rose pour les highlights */
            --success-color: #48bb78;          /* Vert pour les messages de succ√®s */
            --error-color: #f56565;            /* Rouge pour les erreurs */
            --warning-color: #ed8936;          /* Orange pour les avertissements */
            --dark-color: #2d3748;             /* Gris fonc√© pour le texte principal */
            --light-color: #f7fafc;            /* Gris tr√®s clair pour les fonds */
            --border-color: #e2e8f0;           /* Gris clair pour les bordures */
            --text-primary: #2d3748;           /* Couleur du texte principal */
            --text-secondary: #718096;         /* Couleur du texte secondaire */
            
            /* Syst√®me d'ombres coh√©rent */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1), 0 10px 10px rgba(0, 0, 0, 0.04);
        }

        /* =================================================================== */
        /* RESET CSS ET STYLES DE BASE */
        /* =================================================================== */
        * {
            margin: 0;                          /* Supprime les marges par d√©faut */
            padding: 0;                         /* Supprime les paddings par d√©faut */
            box-sizing: border-box;             /* Inclut padding et border dans la taille */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);     /* D√©grad√© de fond */
            min-height: 100vh;                  /* Hauteur minimale plein √©cran */
            color: var(--text-primary);         /* Couleur du texte */
            line-height: 1.6;                   /* Interlignage pour la lisibilit√© */
            position: relative;                 /* Position pour les pseudo-√©l√©ments */
        }

        /* =================================================================== */
        /* EFFETS VISUELS DE FOND */
        /* =================================================================== */
        /* Effet de particules/bulles en arri√®re-plan pour l'esth√©tique */
        body::before {
            content: '';
            position: fixed;                    /* Position fixe pour rester en place lors du scroll */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* D√©grad√©s radiaux pour cr√©er un effet de profondeur */
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            pointer-events: none;               /* N'interf√®re pas avec les interactions */
            z-index: -1;                        /* Reste en arri√®re-plan */
        }

        /* =================================================================== */
        /* BARRE SUP√âRIEURE MODERNE */
        /* =================================================================== */
        /* Header principal avec effet de transparence et blur */
        .topbar {
            background: rgba(255, 255, 255, 0.95);     /* Fond semi-transparent */
            backdrop-filter: blur(20px);               /* Effet de flou moderne */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 20px 30px;
            font-size: 1.8em;
            font-weight: 700;
            letter-spacing: -0.025em;           /* Espacement des lettres ajust√© */
            box-shadow: var(--shadow-md);
            position: sticky;                   /* Reste visible lors du scroll */
            top: 0;
            z-index: 100;                       /* Au-dessus des autres √©l√©ments */
            display: flex;                      /* Layout flexbox */
            justify-content: space-between;     /* Espacement entre les √©l√©ments */
            align-items: center;                /* Centrage vertical */
        }

        /* Titre avec effet de d√©grad√© */
        .topbar .title {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            background-clip: text;              /* Applique le d√©grad√© au texte */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        /* Exception pour l'emoji dans le titre */
        .topbar .title .emoji {
            background: none !important;       /* Annule le d√©grad√© pour l'emoji */
            background-clip: unset !important;
            -webkit-background-clip: unset !important;
            -webkit-text-fill-color: unset !important;
            color: #f39c12 !important;         /* Couleur dor√©e pour l'emoji */
            filter: none !important;
            display: inline-block !important;
        }

        .logout-btn {
            background: linear-gradient(135deg, var(--error-color), #e53e3e);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            min-width: 160px;
            max-width: 220px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .logout-btn:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* --- Cartes modernes avec glassmorphism --- */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin: 30px auto;
            padding: 40px;
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            max-width: 500px;
            min-width: 320px;
            transition: all 0.3s ease;
            display: none;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--secondary-color));
            border-radius: 24px 24px 0 0;
        }

        #auth-choice.card {
            display: block;
            max-width: 400px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .card h1 {
            margin-bottom: 30px;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 2.2em;
            text-align: center;
            letter-spacing: -0.025em;
        }

        .card h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.5em;
        }

        /* --- Logo avec animation --- */
        .logo-img {
            width: 100px;
            height: 100px;
            margin: 0 auto 30px auto;
            border-radius: 50%;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            display: block;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        .logo-img:hover {
            transform: scale(1.05) rotate(5deg);
            box-shadow: var(--shadow-xl);
        }

        /* --- Champs de saisie modernes --- */
        input {
            width: 100%;
            padding: 16px 20px;
            margin: 12px 0 20px 0;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1em;
            font-weight: 400;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-primary);
        }

        input:focus {
            border: 2px solid var(--primary-color);
            outline: none;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        input::placeholder {
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* --- Boutons modernes avec gradients --- */
        button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.5s ease;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        button:active {
            transform: translateY(0);
        }

        /* --- Boutons sp√©cialis√©s --- */
        .btn-danger {
            background: linear-gradient(135deg, var(--error-color), #e53e3e);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #38a169);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--text-secondary), #4a5568);
        }

        /* --- Gestionnaire principal avec layout am√©lior√© --- */
        #app.card {
            max-width: 900px;
            padding: 50px;
        }

        #app h1 {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
        }

        /* --- Formulaire en grid moderne --- */
        .form-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* --- Actions en grille responsive --- */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .actions-grid button {
            margin: 0;
            padding: 14px 20px;
            font-size: 0.95em;
        }

        /* --- Container pour champs mot de passe am√©lior√© --- */
        .password-container {
            position: relative;
            display: block;
            width: 100%;
        }
        
        .password-container input {
            padding-right: 50px;
            width: 100%;
        }
        
        .password-container input::-ms-reveal {
            display: none;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            cursor: pointer;
            padding: 8px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            width: 40px;
        }
        
        .password-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-50%) scale(1.05);
        }
        
        .password-toggle svg {
            display: block;
            width: 20px;
            height: 20px;
            fill: var(--text-secondary);
            transition: fill 0.3s ease;
            opacity: 1;
        }
        
        .password-toggle:hover svg {
            fill: var(--primary-color);
        }

        /* --- Tableau moderne avec style √©l√©gant --- */
        #password-list {
            margin-top: 40px;
        }

        #password-list table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        #password-list th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #password-list td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            text-align: center;
        }

        #password-list tr:last-child td {
            border-bottom: none;
        }

        #password-list tr:nth-child(even) {
            background: rgba(102, 126, 234, 0.02);
        }

        #password-list tr:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        /* --- Boutons d'action du tableau --- */
        .table-action-btn {
            display: block;              /* place chaque bouton sur sa propre ligne */
            width: 100%;                 /* m√™me largeur dans la cellule */
            margin-bottom: 6px;          /* petit √©cart entre les boutons */
            white-space: nowrap;         /* emp√™che le retour √† la ligne dans le texte */
        }

        .table-action-btn:last-child {
            margin-bottom: 0;            /* retire l‚Äôespace sous le dernier bouton */
        }

        /* --- Suggestions am√©lior√©es --- */
        #site-link-list {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 10;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }

        #site-link-list div {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        #site-link-list div:last-child {
            border-bottom: none;
        }

        #site-link-list div:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            transform: translateX(5px);
        }

        /* --- Indicateurs de complexit√© du mot de passe --- */
        #password-hint {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            border-left: 4px solid var(--warning-color);
            box-shadow: var(--shadow-sm);
        }

        #password-hint ul {
            list-style: none;
            margin: 8px 0 0 0;
        }

        #password-hint li {
            padding: 4px 0;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }

        #password-hint li::before {
            content: '\2022';
            margin-right: 8px;
            font-size: 1.2em;
        }

        /* --- Messages d'erreur stylis√©s --- */
        #add-error {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid rgba(245, 101, 101, 0.3);
            color: var(--error-color);
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 0.9em;
            font-weight: 500;
        }

        /* --- Liens stylis√©s --- */
        a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        /* --- Responsive design am√©lior√© --- */
        @media (max-width: 768px) {
            .card {
                margin: 20px;
                padding: 30px 25px;
                max-width: none;
            }

            #app.card {
                padding: 30px 25px;
            }

            .topbar {
                font-size: 1.4em;
                padding: 15px 20px;
            }

            .logout-btn {
                padding: 8px 16px;
                font-size: 0.8em;
                min-width: 120px;
                max-width: 150px;
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }

            #password-list table {
                font-size: 0.85em;
            }

            .table-action-btn {
                padding: 6px 10px;
                font-size: 0.8em;
                min-width: auto;
                margin: 0 2px;
            }
        }

        @media (max-width: 480px) {
            .card h1 {
                font-size: 1.8em;
            }

            input, button {
                padding: 14px 16px;
            }

            #password-list th, #password-list td {
                padding: 12px 8px;
            }

            .topbar {
                font-size: 1.2em;
                padding: 12px 15px;
            }

            .topbar .title {
                font-size: 1em;
            }

            .logout-btn {
                padding: 6px 12px;
                font-size: 0.75em;
                min-width: 100px;
                max-width: 130px;
            }
        }

        /* --- Animations et transitions globales --- */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: fadeInUp 0.6s ease-out;
        }

        /* --- √âtats de chargement --- */
        .loading {
            position: relative;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-color);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Barre sup√©rieure moderne -->
    <div class="topbar">
        <div style="display: flex; align-items: center;">
            <span style="color: #f39c12; margin-right: 8px; font-size: 1em;">üõ°Ô∏è</span>
            <span class="title">HoneyPot Pro Max</span>
        </div>
        <button id="logout-btn" class="logout-btn" style="display:none;" onclick="logout()">
            <span>üö™ D√©connexion</span>
        </button>
    </div>

    <!-- Page d'accueil moderne -->
    <div id="auth-choice" class="card" style="display:block;">
        <h1>‚ú® Bienvenue sur HoneyPot Pro Max</h1>
        <img src="images/HoneyPot.png" alt="Logo HoneyPot Pro Max" class="logo-img">
        <p style="text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 1.1em;">
            Votre gestionnaire de mots de passe s√©curis√© et moderne
        </p>
        <button onclick="showSignup()" class="btn-success">
            <span>üÜï Cr√©er un compte</span>
        </button>
        <button onclick="showLogin()">
            <span>üîí Se connecter</span>
        </button>
    </div>

    <!-- Formulaire de cr√©ation de compte moderne -->
    <div id="setup-container" class="card" style="display: none;">
        <h1>üìù Cr√©er votre compte</h1>
        
        <div class="form-group">
            <label class="form-label">üë§ Identifiant</label>
            <input type="text" id="new-username" placeholder="Choisissez votre identifiant unique">
        </div>
        
        <div class="form-group">
            <label class="form-label">üîë Mot de passe ma√Ætre</label>
            <div class="password-container">
                <input type="password" id="new-master-password" placeholder="Cr√©ez un mot de passe s√©curis√©" oninput="updatePasswordHint()">
                <span class="password-toggle" onclick="toggleNewPassword()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                    </svg>
                </span>
            </div>
        </div>
        
        <div id="password-hint" style="display:none;"></div>
        
        <button onclick="setMasterPassword()" class="btn-success">
            <span>‚úÖ Cr√©er mon compte</span>
        </button>
        
        <div style="margin-top:20px;text-align:center;">
            <a href="#" onclick="showLogin();return false;">
                <span>‚Ü©Ô∏è D√©j√† un compte ? Se connecter</span>
            </a>
        </div>
    </div>

    <!-- Formulaire de connexion moderne -->
    <div id="auth-container" class="card">
        <h1>üîë Connexion</h1>
        
        <div class="form-group">
            <label class="form-label">üë§ Identifiant</label>
            <input type="text" id="login-username" placeholder="Saisissez votre identifiant">
        </div>
        
        <div class="form-group">
            <label class="form-label">üîí Mot de passe</label>
            <div class="password-container">
                <input type="password" id="master-password" placeholder="Saisissez votre mot de passe">
                <span class="password-toggle" onclick="toggleLoginPassword()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                    </svg>
                </span>
            </div>
        </div>
        
        <button onclick="authenticate()">
            <span>üö™ Se connecter</span>
        </button>
        
        <div style="margin-top:20px;text-align:center;">
            <a href="#" onclick="showSignup();return false;">
                <span>üÜï Cr√©er un compte</span>
            </a>
        </div>
    </div>    <!-- Gestionnaire de mots de passe moderne -->
    <div id="app" class="card">
        <h1>üîë Vos mots de passe s√©curis√©s</h1>
        
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">üë§ Identifiant du compte</label>
                <input type="text" id="account-username" placeholder="Ex: john.doe@gmail.com">
            </div>
            
            <div class="form-group" style="position:relative;">
                <label class="form-label">üåê Site web</label>
                <input type="text" id="site-link" placeholder="Ex: https://www.google.com" autocomplete="off" oninput="showSiteSuggestions()" onblur="hideSiteSuggestionsWithDelay()">
                <div id="site-link-list"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">üîí Mot de passe</label>
                <div class="password-container">
                    <input type="password" id="password" placeholder="Votre mot de passe s√©curis√©">
                    <span class="password-toggle" onclick="toggleMainPassword()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </span>
                </div>
            </div>
        </div>
        
        <div class="actions-grid">
            <button onclick="generatePassword()">
                <span>üé≤ G√©n√©rer un mot de passe</span>
            </button>
            <button onclick="addPassword()" class="btn-success">
                <span>‚ûï Ajouter</span>
            </button>
            <button onclick="showMfaSettings()" class="btn-secondary">
                <span>üõ°Ô∏è G√©rer la 2FA</span>
            </button>
            <button onclick="deleteAllPasswords()" class="btn-danger">
                <span>üóëÔ∏è Supprimer tout</span>
            </button>
        </div>
        
        <div id="add-error" style="display:none;"></div>
        
        <!-- Section des mots de passe sauvegard√©s -->
        <div id="password-list"></div>
    </div>

    <!-- Interface de gestion MFA/2FA -->
    <div id="mfa-settings" class="card">
        <h1>üõ°Ô∏è Authentification √† deux facteurs (2FA)</h1>
        
        <div id="mfa-status" style="margin-bottom: 30px;">
            <div style="padding: 20px; border-radius: 12px; background: rgba(255, 193, 7, 0.1); border-left: 4px solid var(--warning-color);">
                <p><strong>‚Ü©Ô∏è V√©rification du statut MFA...</strong></p>
            </div>
        </div>

        <!-- Activation de la MFA -->
        <div id="mfa-setup" style="display: none;">
            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                <h3>üì± Configurer l'authentification √† deux facteurs</h3>
                <p style="margin-bottom: 20px;">1. T√©l√©chargez une application d'authentification comme <strong>Google Authenticator</strong>, <strong>Authy</strong> ou <strong>Microsoft Authenticator</strong></p>
                <p style="margin-bottom: 20px;">2. Scannez le QR code ci-dessous avec votre application :</p>
                
                <div id="qr-code" style="text-align: center; margin: 20px 0; padding: 20px; background: white; border-radius: 12px; display: inline-block; width: 100%;"></div>
                
                <p style="margin-bottom: 20px;">3. Entrez le code √† 6 chiffres g√©n√©r√© par votre application pour confirmer :</p>
                
                <div class="form-group">
                    <input type="text" id="mfa-verify-code" placeholder="123456" maxlength="6" style="text-align: center; font-size: 1.2em; letter-spacing: 0.3em;">
                </div>
                
                <button onclick="setupMfa()" class="btn-success">
                    <span>‚úÖ Activer la 2FA</span>
                </button>
            </div>
        </div>

        <!-- MFA d√©j√† activ√©e -->
        <div id="mfa-active" style="display: none;">
            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                <h3>‚úÖ Authentification √† deux facteurs activ√©e</h3>
                <p>Votre compte est prot√©g√© par l'authentification √† deux facteurs. Un code de v√©rification sera requis √† chaque connexion.</p>
            </div>
            
            <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 12px; padding: 20px;">
                <h4>‚ö†Ô∏è D√©sactivation de la 2FA</h4>
                <p>Pour d√©sactiver l'authentification √† deux facteurs, entrez le code de votre application d'authentification :</p>
                
                <div class="form-group" style="margin-top: 20px;">
                    <input type="text" id="mfa-disable-code" placeholder="123456" maxlength="6" style="text-align: center; font-size: 1.2em; letter-spacing: 0.3em;">
                </div>
                
                <button onclick="disableMfa()" class="btn-danger" style="margin-top: 10px;">
                    <span>üîì D√©sactiver la 2FA</span>
                </button>
            </div>
        </div>

        <button onclick="backToMainApp()" class="btn-secondary" style="margin-top: 30px;">
            <span>‚Ü©Ô∏è Retour au gestionnaire</span>
        </button>
    </div>

    <!-- Interface de v√©rification MFA lors de la connexion -->
    <div id="mfa-verification" class="card">
        <h1>üõ°Ô∏è V√©rification en deux √©tapes</h1>
        
        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 30px; text-align: center;">
            <p><strong>üì± Ouvrez votre application d'authentification</strong></p>
            <p>Entrez le code √† 6 chiffres affich√© pour <strong id="mfa-username-display"></strong></p>
        </div>
        
        <div class="form-group">
            <label class="form-label">üî¢ Code de v√©rification</label>
            <input type="text" id="mfa-login-code" placeholder="123456" maxlength="6" style="text-align: center; font-size: 1.5em; letter-spacing: 0.3em;">
        </div>
        
        <button onclick="verifyMfaLogin()" class="btn-success">
            <span>‚úÖ V√©rifier et se connecter</span>
        </button>
        
        <div style="margin-top: 20px; text-align: center;">
            <a href="#" onclick="cancelMfaLogin(); return false;">
                <span>‚Ü©Ô∏è Annuler la connexion</span>
            </a>
        </div>
    </div>

    <script>
        // ===================================================================
        // CONFIGURATION GLOBALE ET √âTAT DE L'APPLICATION
        // ===================================================================
        const API_BASE_URL = 'http://localhost:9080/api'; // URL de base de l'API via NGINX reverse proxy
        let currentUsername = ''; // Stocke l'identifiant pour le processus MFA
                let siteSuggestions = [
            "google.com", "youtube.com", "facebook.com", "twitter.com", "instagram.com", "linkedin.com", "wikipedia.org",
            "amazon.com", "reddit.com", "netflix.com", "microsoft.com", "apple.com", "github.com", "stackoverflow.com",
            "pinterest.com", "tiktok.com", "yahoo.com", "bing.com", "duckduckgo.com", "paypal.com", "ebay.com",
            "walmart.com", "craigslist.org", "office.com", "live.com", "twitch.tv", "spotify.com", "dropbox.com",
            "wordpress.org", "whatsapp.com", "telegram.org", "discord.com", "zoom.us", "teams.microsoft.com",
            "gmail.com", "outlook.com", "hotmail.com", "adobe.com", "figma.com", "canva.com", "notion.so",
            "trello.com", "slack.com", "esgi.fr"
        ];

        // ===================================================================
        // FONCTIONS DE NAVIGATION ET D'AFFICHAGE
        // ===================================================================
        function showView(viewId) {
            const views = ['auth-choice', 'setup-container', 'auth-container', 'app', 'mfa-settings', 'mfa-verification'];
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = (id === viewId) ? 'block' : 'none';
            });
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.style.display = (viewId === 'app' || viewId === 'mfa-settings') ? 'block' : 'none';
        }

        function showSignup() { showView('setup-container'); }
        function showLogin() { showView('auth-container'); }
        function backToMainApp() { showView('app'); }
        function cancelMfaLogin() { 
            localStorage.removeItem('tempLoginData');
            currentUsername = '';
            showView('auth-container'); 
        }

        // ===================================================================
        // FONCTIONS UTILITAIRES (Toast, Toggles)
        // ===================================================================
        function showToast(message, type = 'success') {
            // Impl√©mentation simple d'un toast/notification
            const toast = document.createElement('div');
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.padding = '12px 24px';
            toast.style.borderRadius = '8px';
            toast.style.color = 'white';
            toast.style.background = type === 'error' ? 'var(--error-color)' : 'var(--success-color)';
            toast.style.boxShadow = 'var(--shadow-lg)';
            toast.style.zIndex = '1000';
            toast.style.transition = 'opacity 0.3s ease';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const toggle = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                // Id√©alement, changer l'ic√¥ne ici
            } else {
                input.type = 'password';
                // Rechanger l'ic√¥ne
            }
        }

        function toggleNewPassword() { togglePasswordVisibility('new-master-password'); }
        function toggleLoginPassword() { togglePasswordVisibility('master-password'); }
        function toggleMainPassword() { togglePasswordVisibility('password'); }

        // ===================================================================
        // LOGIQUE D'AUTHENTIFICATION ET D'INSCRIPTION
        // ===================================================================
        async function setMasterPassword() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-master-password').value;
            const button = event.target;

            if (!username || !password) {
                showToast('Veuillez remplir tous les champs.', 'error');
                return;
            }
            
            button.classList.add('loading');
            button.disabled = true;

            try {
                console.log('Tentative de connexion √†:', `${API_BASE_URL}/register`);
                console.log('Donn√©es envoy√©es:', { username, password: '***' });
                console.log('Donn√©es JSON brutes:', JSON.stringify({ username, password }));
                
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                console.log('R√©ponse du serveur:', response.status, response.statusText);
                const result = await response.json();
                console.log('Donn√©es re√ßues:', result);

                if (response.ok) {
                    showToast(result.message || 'Utilisateur cr√©√© avec succ√®s!', 'success');
                    setTimeout(() => {
                        showLogin();
                        document.getElementById('login-username').value = username;
                    }, 1500);
                } else {
                    console.error('Erreur d√©taill√©e du serveur:', result);
                    showToast(result.detail || 'Erreur lors de la cr√©ation du compte.', 'error');
                }
            } catch (error) {
                console.error('Erreur d√©taill√©e:', error);
                console.error('Message d\'erreur:', error.message);
                console.error('Stack trace:', error.stack);
                
                let errorMessage = 'Erreur de connexion au serveur.';
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Impossible de contacter le serveur. V√©rifiez que le backend est d√©marr√© sur le port 9443.';
                } else if (error.message.includes('SSL') || error.message.includes('certificate')) {
                    errorMessage = 'Erreur de certificat SSL. Essayez d\'acc√©der √† http://localhost:9443 dans votre navigateur d\'abord.';
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'Erreur CORS. V√©rifiez la configuration du backend.';
                }
                
                showToast(errorMessage, 'error');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        async function authenticate() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('master-password').value;
            const button = event.target;

            if (!username || !password) {
                showToast('Identifiant et mot de passe requis.', 'error');
                return;
            }

            button.classList.add('loading');
            button.disabled = true;
            currentUsername = username; // Stocker pour une √©ventuelle v√©rification MFA

            try {
                console.log('Tentative de connexion √†:', `${API_BASE_URL}/login`);
                
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                console.log('R√©ponse du serveur:', response.status, response.statusText);
                const data = await response.json();
                console.log('Donn√©es re√ßues:', data);

                if (!response.ok) {
                    throw new Error(data.detail || 'Identifiants incorrects.');
                }

                if (data.mfa_required) {
                    // Stocker temporairement les donn√©es de connexion pour la v√©rification MFA
                    localStorage.setItem('tempLoginData', btoa(`${username}:${password}`));
                    document.getElementById('mfa-username-display').textContent = username;
                    showView('mfa-verification');
                } else {
                    // Connexion r√©ussie sans MFA - utiliser le token fourni par l'API
                    if (data.user_b64_token) {
                        localStorage.setItem('currentUser', data.user_b64_token);
                    } else {
                        // Fallback : cr√©er notre propre token
                        localStorage.setItem('currentUser', btoa(`${username}:${password}`));
                    }
                    showView('app');
                    loadPasswords();
                }
            } catch (error) {
                console.error('Erreur d√©taill√©e:', error);
                
                let errorMessage = error.message;
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Impossible de contacter le serveur. V√©rifiez que le backend est d√©marr√©.';
                }
                
                showToast(errorMessage, 'error');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUsername = '';
            document.getElementById('password-list').innerHTML = '';
            showView('auth-choice');
        }

        // ===================================================================
        // LOGIQUE MFA (Authentification √† deux facteurs)
        // ===================================================================
        async function showMfaSettings() {
            showView('mfa-settings');
            const statusDiv = document.getElementById('mfa-status');
            const setupDiv = document.getElementById('mfa-setup');
            const activeDiv = document.getElementById('mfa-active');
            const currentUser = localStorage.getItem('currentUser');
            
            if (!currentUser) {
                showView('auth-choice');
                return;
            }

            statusDiv.innerHTML = '<div style="padding: 20px; border-radius: 12px; background: rgba(255, 193, 7, 0.1); border-left: 4px solid var(--warning-color);"><p><strong>üîÑ V√©rification du statut MFA...</strong></p></div>';
            setupDiv.style.display = 'none';
            activeDiv.style.display = 'none';

            try {
                // R√©cup√©rer le nom d'utilisateur et mot de passe depuis le localStorage
                const decodedUser = atob(currentUser);
                const [username, password] = decodedUser.split(':');
                
                const response = await fetch(`${API_BASE_URL}/mfa/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Erreur lors de la v√©rification du statut MFA');
                }

                if (data.mfa_enabled) {
                    statusDiv.innerHTML = '';
                    setupDiv.style.display = 'none';
                    activeDiv.style.display = 'block';
                } else {
                    statusDiv.innerHTML = '';
                    setupDiv.style.display = 'block';
                    activeDiv.style.display = 'none';
                    await generateMfaQrCode();
                }
                
            } catch (error) {
                console.error('Erreur lors de la v√©rification MFA:', error);
                statusDiv.innerHTML = `
                    <div style="padding: 20px; border-radius: 12px; background: rgba(245, 101, 101, 0.1); border-left: 4px solid var(--error-color);">
                        <p><strong>‚ùå Erreur</strong> - ${error.message}</p>
                    </div>
                `;
            }
        }

        async function generateMfaQrCode() {
            const currentUser = localStorage.getItem('currentUser');
            const qrCodeDiv = document.getElementById('qr-code');
            
            if (!currentUser) {
                showView('auth-choice');
                return;
            }

            try {
                qrCodeDiv.innerHTML = '<div style="text-align: center; padding: 20px;">üîÑ G√©n√©ration du QR code...</div>';
                
                const response = await fetch(`${API_BASE_URL}/mfa/setup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user: currentUser })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Erreur lors de la g√©n√©ration du QR code');
                }

                // V√©rification de la biblioth√®que QR et g√©n√©ration du QR code
                if (typeof qrcode !== 'undefined') {
                    // G√©n√©rer le QR code avec qrcode-generator (plus fiable)
                    try {
                        const qr = qrcode(0, 'M'); // Type 0 (auto), correction niveau M
                        qr.addData(data.provisioning_uri);
                        qr.make();
                        
                        // Cr√©er l'√©l√©ment image du QR code
                        const qrCodeHTML = qr.createImgTag(6, 10); // Taille 6, marge 10
                        qrCodeDiv.innerHTML = `
                            <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="color: #007bff; margin-bottom: 15px;">üì± Scannez ce QR code</h4>
                                ${qrCodeHTML}
                                <p style="margin-top: 15px; color: #666; font-size: 0.9em;">Utilisez votre application d'authentification pour scanner</p>
                            </div>
                        `;
                        return; // Sortir si le QR code a √©t√© g√©n√©r√© avec succ√®s
                    } catch (qrError) {
                        console.warn('Erreur avec qrcode-generator, utilisation du fallback:', qrError);
                    }
                } else if (typeof QRCode !== 'undefined' && QRCode.toCanvas) {
                    // Fallback 1: QRCode.js (si disponible)
                    qrCodeDiv.innerHTML = '<canvas id="qrcode-canvas" style="display: block; margin: 0 auto; border-radius: 8px; background: white; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></canvas>';
                    
                    try {
                        await new Promise((resolve, reject) => {
                            QRCode.toCanvas(document.getElementById('qrcode-canvas'), data.provisioning_uri, {
                                width: 250,
                                height: 250,
                                margin: 2,
                                color: {
                                    dark: '#000000',
                                    light: '#ffffff'
                                }
                            }, function (error) {
                                if (error) {
                                    reject(error);
                                } else {
                                    resolve();
                                }
                            });
                        });
                        return; // Sortir si le QR code a √©t√© g√©n√©r√© avec succ√®s
                    } catch (qrError) {
                        console.warn('Erreur avec QRCode.js, utilisation du fallback API');
                    }
                }
                
                // Si aucune biblioth√®que locale ne fonctionne, utiliser le fallback API
                throw new Error('Biblioth√®ques QR locales non disponibles');
                
            } catch (error) {
                // Fallback am√©lior√© avec l'URI de configuration et un lien Google Charts
                const uri = error.response ? error.response.provisioning_uri : (error.data ? error.data.provisioning_uri : '');
                
                // R√©cup√©rer l'URI depuis la r√©ponse si disponible
                let fallbackUri = '';
                try {
                    const response = await fetch(`${API_BASE_URL}/mfa/setup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: localStorage.getItem('currentUser') })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        fallbackUri = data.provisioning_uri;
                    }
                } catch (e) {
                    // Erreur silencieuse pour √©viter l'encombrement des logs
                }

                qrCodeDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #007bff;">
                        <h4 style="color: #007bff; margin-bottom: 15px;">üì± QR Code pour l'authentification</h4>
                        
                        ${fallbackUri ? `
                            <!-- QR Code via API externe (fallback principal) -->
                            <div style="margin: 20px 0;">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(fallbackUri)}" 
                                     alt="QR Code MFA" 
                                     style="border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white; padding: 10px;"
                                     onerror="this.style.display='none'; document.getElementById('manual-config').style.display='block';"
                                     onload="console.log('QR Code externe charg√© avec succ√®s')">
                            </div>
                            
                            <!-- Configuration manuelle (fallback final) -->
                            <div id="manual-config" style="display: none;">
                                <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 8px; border: 2px solid #28a745;">
                                    <h5 style="color: #28a745; margin-bottom: 10px;">üîë Configuration manuelle</h5>
                                    <p><strong>Cl√© secr√®te :</strong></p>
                                    <p style="font-family: monospace; font-size: 1.1em; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #007bff; word-break: break-all; color: #007bff; font-weight: bold; cursor: pointer;" 
                                       onclick="navigator.clipboard.writeText('${fallbackUri.match(/secret=([A-Z0-9]+)/)?.[1] || ''}').then(() => alert('Cl√© copi√©e dans le presse-papiers !'))">
                                       ${fallbackUri.match(/secret=([A-Z0-9]+)/)?.[1] || 'Cl√© non disponible'}
                                    </p>
                                    <p style="margin-top: 15px; font-size: 0.9em; color: #666;">üìã Cliquez sur la cl√© pour la copier</p>
                                </div>
                            </div>
                        ` : `
                            <!-- Si aucune URI n'est disponible -->
                            <div style="padding: 20px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border: 2px solid #ffc107;">
                                <p style="color: #856404;"><strong>‚ö†Ô∏è Erreur de configuration</strong></p>
                                <p>Impossible de g√©n√©rer le QR code. Veuillez contacter l'administrateur.</p>
                            </div>
                        `}
                        
                        <div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                            <p style="color: #1e40af;"><strong>üìù Instructions :</strong></p>
                            <ol style="text-align: left; margin: 10px 0; padding-left: 20px; color: #374151;">
                                <li>Ouvrez votre application d'authentification</li>
                                <li>Choisissez "Ajouter un compte" ou "Scanner un QR code"</li>
                                <li>Scannez le QR code ci-dessus ou utilisez la cl√© manuelle</li>
                                <li>Le nom du compte sera : <strong style="color: #007bff;">ProjetAnnuelESGI</strong></li>
                            </ol>
                        </div>
                    </div>
                `;
            }
        }

        async function setupMfa() {
            const verifyCode = document.getElementById('mfa-verify-code').value;
            const currentUser = localStorage.getItem('currentUser');
            const button = event.target;

            if (!verifyCode || verifyCode.length !== 6) {
                showToast('Veuillez entrer un code √† 6 chiffres.', 'error');
                return;
            }

            if (!currentUser) {
                showView('auth-choice');
                return;
            }

            button.classList.add('loading');
            button.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/mfa/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user: currentUser,
                        otp_code: verifyCode
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Code de v√©rification invalide');
                }

                showToast('üõ°Ô∏è Authentification √† deux facteurs activ√©e avec succ√®s !', 'success');
                document.getElementById('mfa-verify-code').value = '';
                
                // Rafra√Æchir l'affichage des param√®tres MFA
                setTimeout(() => {
                    showMfaSettings();
                }, 1500);
                
            } catch (error) {
                console.error('Erreur lors de l\'activation MFA:', error);
                showToast(error.message, 'error');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        async function verifyMfaLogin() {
            const otpCode = document.getElementById('mfa-login-code').value;
            const button = event.target;

            if (!otpCode || otpCode.length !== 6) {
                showToast('Veuillez entrer un code √† 6 chiffres.', 'error');
                return;
            }

            if (!currentUsername) {
                showView('auth-choice');
                return;
            }

            button.classList.add('loading');
            button.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/login/otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: currentUsername,
                        otp_code: otpCode
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Code de v√©rification invalide');
                }

                // Connexion r√©ussie avec MFA
                showToast('üõ°Ô∏è Connexion s√©curis√©e r√©ussie !', 'success');
                
                // Cr√©er le token utilisateur (similaire √† la connexion normale)
                const decodedUser = atob(localStorage.getItem('tempLoginData') || '');
                const [username, password] = decodedUser.split(':');
                const userToken = btoa(`${username}:${password}`);
                
                localStorage.setItem('currentUser', userToken);
                localStorage.removeItem('tempLoginData');
                
                showView('app');
                loadPasswords();
                
            } catch (error) {
                console.error('Erreur lors de la v√©rification MFA:', error);
                showToast(error.message, 'error');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        async function disableMfa() {
            const otpCode = document.getElementById('mfa-disable-code').value;
            const currentUser = localStorage.getItem('currentUser');
            const button = event.target;

            if (!otpCode || otpCode.length !== 6) {
                showToast('Veuillez entrer un code √† 6 chiffres.', 'error');
                return;
            }

            if (!currentUser) {
                showView('auth-choice');
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir d√©sactiver l\'authentification √† deux facteurs ? Cette action r√©duira la s√©curit√© de votre compte.')) {
                return;
            }

            button.classList.add('loading');
            button.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/mfa/disable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user: currentUser,
                        otp_code: otpCode
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Code de v√©rification invalide');
                }

                showToast('üîì Authentification √† deux facteurs d√©sactiv√©e', 'success');
                document.getElementById('mfa-disable-code').value = '';
                
                // Rafra√Æchir l'affichage des param√®tres MFA
                setTimeout(() => {
                    showMfaSettings();
                }, 1500);
                
            } catch (error) {
                console.error('Erreur lors de la d√©sactivation MFA:', error);
                showToast(error.message, 'error');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        // ===================================================================
        // GESTION DES MOTS DE PASSE
        // ===================================================================
        async function loadPasswords() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                showView('auth-choice');
                return;
            }
            
            const listDiv = document.getElementById('password-list');
            listDiv.innerHTML = 'Chargement des mots de passe...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/list?user=${currentUser}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Erreur lors du chargement');
                }
                
                renderPasswords(data.passwords || []);
                
            } catch (error) {
                listDiv.innerHTML = `<p style="color: var(--error-color);">${error.message}</p>`;
            }
        }

        function renderPasswords(passwords) {
            const listDiv = document.getElementById('password-list');
            if (passwords.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Aucun mot de passe enregistr√©.</p>';
                return;
            }
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Site</th>
                            <th>Identifiant</th>
                            <th>Mot de passe</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${passwords.map((p, index) => `
                            <tr data-site="${p.site}" data-account="${p.account}">
                                <td>${p.site}</td>
                                <td>${p.account}</td>
                                <td id="password-cell-${index}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                                <td>
                                    <button class="table-action-btn btn-secondary" onclick="revealPassword(${index}, '${p.password}')">üëÅÔ∏è R√©v√©ler</button>
                                    <button class="table-action-btn btn-danger" onclick="deletePassword('${p.site}', '${p.account}')">üóëÔ∏è Supprimer</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            listDiv.innerHTML = table;
        }

        async function addPassword() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                showView('auth-choice');
                return;
            }
            
            const account_username = document.getElementById('account-username').value;
            const site_link = document.getElementById('site-link').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('add-error');

            if (!account_username || !site_link || !password) {
                errorDiv.textContent = 'Veuillez remplir tous les champs.';
                errorDiv.style.display = 'block';
                return;
            }
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user: currentUser,
                        site: site_link,
                        account: account_username,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Erreur lors de l\'ajout');
                }
                
                showToast('Mot de passe ajout√© avec succ√®s!', 'success');
                loadPasswords();
                // Vider les champs
                document.getElementById('account-username').value = '';
                document.getElementById('site-link').value = '';
                document.getElementById('password').value = '';
                
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        }

        async function deletePassword(site, account) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce mot de passe ?')) return;
            
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                showView('auth-choice');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user: currentUser,
                        site: site,
                        account: account
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Erreur lors de la suppression');
                }
                
                showToast('Mot de passe supprim√©.', 'success');
                loadPasswords();
                
            } catch (error) {
                showToast(error.message, 'error');
            }
        }
        
        async function deleteAllPasswords() {
            if (!confirm('ATTENTION : √ätes-vous s√ªr de vouloir supprimer TOUS vos mots de passe ? Cette action est irr√©versible.')) return;
            
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                showView('auth-choice');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/delete_all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user: currentUser })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Erreur lors de la suppression');
                }
                
                showToast('Tous les mots de passe ont √©t√© supprim√©s.', 'success');
                loadPasswords();
                
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function revealPassword(index, password) {
            const cell = document.getElementById(`password-cell-${index}`);
            const isRevealed = cell.textContent !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            
            if (isRevealed) {
                // Masquer le mot de passe
                cell.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            } else {
                // R√©v√©ler le mot de passe
                cell.textContent = password;
                // Masquer automatiquement apr√®s 10 secondes
                setTimeout(() => {
                    cell.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                }, 10000);
            }
        }

        function generatePassword() {
            const length = 16;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+~`|}{[]:;?><,./-=";
            let retVal = "";
            // Ajoute au moins un de chaque type de caract√®re pour la robustesse
            retVal += "abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random() * 26)];
            retVal += "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random() * 26)];
            retVal += "0123456789"[Math.floor(Math.random() * 10)];
            retVal += "!@#$%^&*()"[Math.floor(Math.random() * 10)];
            for (let i = 4; i < length; i++) {
                retVal += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            // M√©lange le mot de passe pour que les premiers caract√®res ne soient pas pr√©visibles
            document.getElementById('password').value = retVal.split('').sort(() => 0.5 - Math.random()).join('');
            showToast('Mot de passe g√©n√©r√© et copi√© dans le champ!', 'success');
        }

        // ===================================================================
        // FONCTIONS D'AIDE √Ä L'INTERFACE (Suggestions, Hints)
        // ===================================================================
        function updatePasswordHint() {
            const password = document.getElementById('new-master-password').value;
            const hint = document.getElementById('password-hint');
            if (password.length === 0) {
                hint.style.display = 'none';
                return;
            }
            hint.style.display = 'block';
            const checks = {
                'Au moins 8 caract√®res': password.length >= 8,
                'Une lettre majuscule': /[A-Z]/.test(password),
                'Une lettre minuscule': /[a-z]/.test(password),
                'Un chiffre': /[0-9]/.test(password),
                'Un caract√®re sp√©cial': /[^A-Za-z0-9]/.test(password)
            };
            let html = '<ul>';
            for (const [text, passed] of Object.entries(checks)) {
                html += `<li style="color: ${passed ? 'var(--success-color)' : 'var(--error-color)'};">${passed ? '‚úî' : '‚úñ'} ${text}</li>`;
            }
            html += '</ul>';
            hint.innerHTML = html;
        }

        function showSiteSuggestions() {
            const input = document.getElementById('site-link');
            const list = document.getElementById('site-link-list');
            const value = input.value.toLowerCase();
            if (!value) {
                list.style.display = 'none';
                return;
            }
            const filtered = siteSuggestions.filter(s => s.includes(value));
            if (filtered.length === 0) {
                list.style.display = 'none';
                return;
            }
            list.innerHTML = filtered.map(s => `<div onclick="selectSiteSuggestion('${s}')">${s}</div>`).join('');
            list.style.display = 'block';
        }

        function selectSiteSuggestion(site) {
            document.getElementById('site-link').value = `https://${site}`;
            document.getElementById('site-link-list').style.display = 'none';
        }

        function hideSiteSuggestionsWithDelay() {
            // L√©ger d√©lai pour permettre au clic de s'enregistrer
            setTimeout(() => {
                const list = document.getElementById('site-link-list');
                if (list) list.style.display = 'none';
            }, 200);
        }

        // ===================================================================
        // FONCTIONS DE GESTION D'√âV√âNEMENTS
        // ===================================================================
        function toggleNewPassword() {
            const input = document.getElementById('new-master-password');
            const toggle = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                toggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 6c3.79 0 7.17 2.13 8.82 5.5C19.17 14.87 15.79 17 12 17s-7.17-2.13-8.82-5.5C4.83 8.13 8.21 6 12 6m0-2C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 5c1.38 0 2.5 1.12 2.5 2.5S13.38 14 12 14s-2.5-1.12-2.5-2.5S10.62 9 12 9m0-2c-2.48 0-4.5 2.02-4.5 4.5S9.52 16 12 16s4.5-2.02 4.5-4.5S14.48 7 12 7z"/>
                </svg>`;
            } else {
                input.type = 'password';
                toggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>`;
            }
        }
        
        function toggleLoginPassword() {
            const input = document.getElementById('master-password');
            const toggle = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                toggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 6c3.79 0 7.17 2.13 8.82 5.5C19.17 14.87 15.79 17 12 17s-7.17-2.13-8.82-5.5C4.83 8.13 8.21 6 12 6m0-2C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 5c1.38 0 2.5 1.12 2.5 2.5S13.38 14 12 14s-2.5-1.12-2.5-2.5S10.62 9 12 9m0-2c-2.48 0-4.5 2.02-4.5 4.5S9.52 16 12 16s4.5-2.02 4.5-4.5S14.48 7 12 7z"/>
                </svg>`;
            } else {
                input.type = 'password';
                toggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>`;
            }
        }
        
        function toggleMainPassword() {
            const input = document.getElementById('password');
            const toggle = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                toggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 6c3.79 0 7.17 2.13 8.82 5.5C19.17 14.87 15.79 17 12 17s-7.17-2.13-8.82-5.5C4.83 8.13 8.21 6 12 6m0-2C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 5c1.38 0 2.5 1.12 2.5 2.5S13.38 14 12 14s-2.5-1.12-2.5-2.5S10.62 9 12 9m0-2c-2.48 0-4.5 2.02-4.5 4.5S9.52 16 12 16s4.5-2.02 4.5-4.5S14.48 7 12 7z"/>
                </svg>`;
            } else {
                input.type = 'password';
                toggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>`;
            }
        }
    </script>
</body>
</html>
